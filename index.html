<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shobi Perfume Inspiration - Experience</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root, [data-bs-theme="light"] {
            --bs-primary-rgb: 60, 100, 255;
            --bs-secondary-rgb: 108, 117, 125;
            --bs-body-bg: #f8f9fa;
            --bs-tertiary-bg: #ffffff;
            --gradient-start: #eef2f3;
            --gradient-end: #ffffff;
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: #1c1c1e;
            --bs-body-color: #dee2e6;
            --bs-tertiary-bg: #2c2c2e;
            --bs-primary-rgb: 70, 130, 255;
            --gradient-start: #232526;
            --gradient-end: #414345;
        }
        
        [data-theme="deepsea"] {
            --bs-body-bg: #1A2238;
            --bs-body-color: #F4F7FF;
            --bs-tertiary-bg: #253354;
            --bs-primary: #9DAAF2;
            --bs-primary-rgb: 157, 170, 242;
            --bs-secondary: #FF6A5C;
            --bs-dark: #F4F7FF;
            --gradient-start: #0f2027;
            --gradient-end: #203a43;
        }
        
        [data-theme="sandstone"] {
            --bs-body-bg: #FDF6E3;
            --bs-body-color: #657B83;
            --bs-tertiary-bg: #F5EADD;
            --bs-primary: #D33682;
            --bs-primary-rgb: 211, 54, 130;
            --bs-secondary: #2AA198;
            --bs-dark: #002B36;
            --gradient-start: #fdfcfb;
            --gradient-end: #e2d1c3;
        }
        
        [data-theme="rosequartz"] {
            --bs-body-bg: #f7f3f7;
            --bs-body-color: #5c4f5c;
            --bs-tertiary-bg: #ffffff;
            --bs-primary: #e8a2af;
            --bs-primary-rgb: 232, 162, 175;
            --bs-secondary: #9d8c9d;
            --bs-dark: #3b2e3b;
            --gradient-start: #f8f5f8;
            --gradient-end: #e8dde4;
        }

        [data-theme="forest"] {
            --bs-body-bg: #2a3d33;
            --bs-body-color: #e8e8e8;
            --bs-tertiary-bg: #3c5446;
            --bs-primary: #a3b18a;
            --bs-primary-rgb: 163, 177, 138;
            --bs-secondary: #588157;
            --bs-dark: #e8e8e8;
            --gradient-start: #233128;
            --gradient-end: #3a4a3f;
        }

        body {
            background-image: linear-gradient(120deg, var(--gradient-start), var(--gradient-end));
        }

        .perfume-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 0;
        }
        .perfume-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        }
        
        .favorite-btn {
            position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 1.5rem; color: #ccc; transition: color 0.2s ease;
        }
        .favorite-btn.is-favorite { color: #dc3545; }
        .brand-link { cursor: pointer; text-decoration: underline; }
        .accord-tag { cursor: pointer; }
        .list-group-item .favorite-btn { position: static; }
        
        .sidebar { position: sticky; top: 80px; }
        .accordion-button:not(.collapsed) { background-color: rgba(var(--bs-primary-rgb), 0.1); }
        #topAccordsChart { cursor: pointer; }
    </style>
</head>
<body>

    <header class="bg-dark text-white p-3 text-center sticky-top shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0">Shobi Perfume Inspiration</h1>
            <div>
                 <button id="surprise-btn" class="btn btn-outline-warning me-2">
                    <i class="fas fa-random"></i> Surprise Me!
                </button>
                <button id="favorites-btn" class="btn btn-outline-light me-2">
                    <i class="fas fa-heart"></i> Favorites <span class="badge bg-danger ms-1" id="favorites-count">0</span>
                </button>
                 <div class="btn-group">
                    <button class="btn btn-outline-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-palette"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item theme-choice" href="#" data-theme-value="light">Default</a></li>
                        <li><a class="dropdown-item theme-choice" href="#" data-theme-value="dark">Midnight</a></li>
                        <li><a class="dropdown-item theme-choice" href="#" data-theme-value="deepsea">Deep Sea</a></li>
                        <li><a class="dropdown-item theme-choice" href="#" data-theme-value="sandstone">Sandstone</a></li>
                        <li><a class="dropdown-item theme-choice" href="#" data-theme-value="rosequartz">Rose Quartz</a></li>
                        <li><a class="dropdown-item theme-choice" href="#" data-theme-value="forest">Forest</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Filter Sidebar -->
            <aside class="col-lg-3">
                <div class="sidebar">
                    <div class="p-3 rounded bg-body-tertiary">
                        <h4>Filters</h4>
                        <hr>
                        <div class="accordion" id="filter-accordion">
                            <!-- Accordion filter items generated here -->
                        </div>
                        <button id="reset-filters-btn" class="btn btn-sm btn-outline-secondary w-100 mt-3">Reset Filters</button>
                        <hr>
                        <div id="stats-container">
                            <h4 class="mt-4">Inspiration</h4>
                            <canvas id="topAccordsChart"></canvas>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="col-lg-9">
                <div id="main-view">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-2 align-items-center">
                                <div class="col-lg-6">
                                    <input type="text" id="search-input" class="form-control" placeholder="Search for original perfume or brand...">
                                </div>
                                <div class="col-lg-6 d-flex justify-content-end align-items-center">
                                    <div id="sort-btn-group" class="btn-group me-3">
                                        <button id="sort-by-name" class="btn btn-outline-secondary active">Name</button>
                                        <button id="sort-by-brand" class="btn btn-outline-secondary">Brand</button>
                                    </div>
                                    <div id="view-btn-group" class="btn-group">
                                        <button id="view-grid" class="btn btn-secondary active"><i class="fas fa-th-large"></i></button>
                                        <button id="view-list" class="btn btn-secondary"><i class="fas fa-list"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 id="results-count">Loading perfumes...</h5>
                    </div>
                    <div id="perfume-list" class="row g-4"></div>
                </div>
                <div id="brand-view" class="d-none">
                    <button id="back-to-all-btn" class="btn btn-secondary mb-3"><i class="fas fa-arrow-left"></i> Back to all</button>
                    <div id="brand-info" class="mb-4"></div>
                    <div id="brand-perfume-list" class="row g-4"></div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="modal fade" id="perfume-details-modal" tabindex="-1" aria-labelledby="perfumeDetailsLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="perfumeDetailsLabel">Perfume Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="perfume-details-content"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>
        let allPerfumes = [];
        const state = { searchQuery: '', sortKey: 'inspiredBy', activeFilters: {}, favorites: [], showingFavorites: false, viewMode: 'grid', currentView: 'main' };
        let topAccordsChart = null;
        let scentProfileChart = null;
        let perfumeDetailsModal;

        function displayPerfumes(perfumes, containerId, customTitle = null) {
            const listElement = document.getElementById(containerId);
            listElement.className = state.viewMode === 'grid' ? 'row g-4' : 'list-group';
            
            const resultsCountEl = document.getElementById('results-count');
            if (customTitle) {
                resultsCountEl.innerHTML = customTitle;
            } else if (containerId === 'perfume-list') {
                 resultsCountEl.textContent = `Showing ${perfumes.length} results`;
            }

            if(perfumes.length === 0) {
                listElement.innerHTML = '<div class="col-12"><div class="alert alert-info">No perfumes matched your criteria.</div></div>';
                return;
            }

            const perfumesHTML = perfumes.map(perfume => {
                const p = perfume.item ? perfume.item : perfume;
                const isFavorite = state.favorites.includes(p.code);
                const accordsText = (p.mainAccords || []).slice(0, 3).map(a => `<span class="badge bg-secondary me-1 accord-tag" onclick="handleAccordClick('${a}')">${a}</span>`).join('');
                
                const shobiLink = `https://leparfum.com.gr/en/search?controller=search&s=${p.code}`;
                const parfumoLinkHTML = p.link ? `<a href="${p.link}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-info ms-1">Parfumo</a>` : '';

                let genderIcon = '';
                if (p.genderAffinity === 'Feminine') genderIcon = '<i class="fas fa-venus text-danger ms-2"></i>';
                else if (p.genderAffinity === 'Masculine') genderIcon = '<i class="fas fa-mars text-primary ms-2"></i>';
                else if (p.genderAffinity === 'Unisex') genderIcon = '<i class="fas fa-venus-mars text-warning ms-2"></i>';
                
                if (state.viewMode === 'grid') {
                    return `
                    <div class="col-md-6 col-xl-4">
                        <div class="card h-100 shadow-sm perfume-card bg-body-tertiary">
                             <div class="card-body d-flex flex-column position-relative">
                                <i class="fas fa-heart favorite-btn ${isFavorite ? 'is-favorite' : ''}" data-code="${p.code}"></i>
                                <h5 class="card-title">${p.inspiredBy}${genderIcon}</h5>
                                <h6 class="card-subtitle mb-2 text-muted"><span class="brand-link" data-brand="${p.brand}">${p.brand}</span></h6>
                                <p class="card-text small flex-grow-1">${String(p.description || 'No description available.').substring(0, 80)}...</p>
                                <div class="mb-2">${accordsText}</div>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showPerfumeDetails('${p.code}')">Details</button>
                                    <a href="${shobiLink}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary ms-1">Shobi</a>
                                    ${parfumoLinkHTML}
                                </div>
                            </div>
                        </div>
                    </div>`;
                } else {
                     return `
                     <li class="list-group-item bg-body-tertiary">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div>
                                <h5 class="mb-1">${p.inspiredBy}${genderIcon} <small class="text-muted">by <span class="brand-link" data-brand="${p.brand}">${p.brand}</span></small></h5>
                                <p class="mb-1 small">${String(p.description || 'No description available.').substring(0, 120)}...</p>
                                <div class="mt-2">${accordsText}</div>
                            </div>
                            <div class="d-flex flex-column align-items-end ms-3 text-nowrap" style="min-width: 120px;">
                                <i class="fas fa-heart favorite-btn mb-auto ${isFavorite ? 'is-favorite' : ''}" data-code="${p.code}"></i>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showPerfumeDetails('${p.code}')">Details</button>
                                    <a href="${shobiLink}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary ms-1">Shobi</a>
                                    ${parfumoLinkHTML}
                                </div>
                            </div>
                        </div>
                    </li>`;
                }
            }).join('');

            listElement.innerHTML = perfumesHTML;
            
            listElement.querySelectorAll('.favorite-btn').forEach(btn => btn.addEventListener('click', toggleFavorite));
            listElement.querySelectorAll('.brand-link').forEach(link => link.addEventListener('click', e => showBrandView(e.target.dataset.brand)));
        }

        function applyFiltersAndRender() {
            let filtered = [...allPerfumes];
            if (state.showingFavorites) {
                filtered = filtered.filter(p => state.favorites.includes(p.code));
            }
            if (state.searchQuery) {
                const query = state.searchQuery.toLowerCase();
                // FINAL FIX: Ensure values are strings before calling toLowerCase()
                filtered = filtered.filter(p => 
                    String(p.inspiredBy || '').toLowerCase().includes(query) || 
                    String(p.brand || '').toLowerCase().includes(query)
                );
            }
            for (const key in state.activeFilters) {
                const selected = state.activeFilters[key];
                if (selected.length > 0) {
                    filtered = filtered.filter(p => {
                        if (Array.isArray(p[key])) return selected.some(val => p[key].includes(val));
                        return selected.includes(p[key]);
                    });
                }
            }
            filtered.sort((a, b) => String(a[state.sortKey] || '').localeCompare(String(b[state.sortKey] || '')));
            displayPerfumes(filtered, 'perfume-list');
        }

        function createFilters() {
            const accordion = document.getElementById('filter-accordion');
            const filters = {
                mainAccords: { title: 'Main Accords', options: new Set(), limit: 10 },
                seasons: { title: 'Season', options: new Set() },
                occasions: { title: 'Occasion', options: new Set() },
                genderAffinity: { title: 'Gender', options: new Set() }
            };

            const allOccasions = new Set();
            allPerfumes.forEach(p => {
                (p.seasons || []).forEach(s => filters.seasons.options.add(s));
                (p.occasions || []).forEach(o => allOccasions.add(o));
                if (p.genderAffinity) filters.genderAffinity.options.add(p.genderAffinity);
            });
            [...allOccasions].sort().forEach(o => filters.occasions.options.add(o));

            const counts = allPerfumes.flatMap(p => p.mainAccords || []).reduce((acc, a) => { acc[a] = (acc[a] || 0) + 1; return acc; }, {});
            const topAccords = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, filters.mainAccords.limit).map(e => e[0]);
            topAccords.forEach(a => filters.mainAccords.options.add(a));
            
            let html = '';
            for (const key in filters) {
                state.activeFilters[key] = [];
                const options = [...filters[key].options].sort();
                if (options.length === 0) continue;

                html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-${key}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${key}">
                            ${filters[key].title}
                        </button>
                    </h2>
                    <div id="collapse-${key}" class="accordion-collapse collapse" aria-labelledby="heading-${key}">
                        <div class="accordion-body" style="max-height: 200px; overflow-y: auto;">`;
                options.forEach(option => {
                    html += `<div class="form-check"><input class="form-check-input filter-checkbox" type="checkbox" value="${option}" id="${key}-${option}" data-filter-key="${key}"><label class="form-check-label" for="${key}-${option}">${option}</label></div>`;
                });
                html += `</div></div></div>`;
            }
            accordion.innerHTML = html;
            accordion.querySelectorAll('.filter-checkbox').forEach(box => box.addEventListener('change', handleFilterChange));
        }
        
        function calculateAndShowStats() {
            const chartCanvas = document.getElementById('topAccordsChart');
            const ctx = chartCanvas.getContext('2d');
            const counts = allPerfumes.flatMap(p => p.mainAccords || []).reduce((acc, a) => { acc[a] = (acc[a] || 0) + 1; return acc; }, {});
            const top5 = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            if (topAccordsChart) topAccordsChart.destroy();
            topAccordsChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: top5.map(a => a[0]), 
                    datasets: [{ 
                        label: 'Most Popular Accords', 
                        data: top5.map(a => a[1]),
                        backgroundColor: ['rgba(60, 100, 255, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(255, 205, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)'],
                    }] 
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { position: 'top' } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chartElement = elements[0];
                            const label = topAccordsChart.data.labels[chartElement.index];
                            handleAccordClick(label);
                        }
                    }
                }
            });
        }
        
        function showPerfumeDetails(code) {
            const perfume = allPerfumes.find(p => p.code === code);
            if (!perfume) return;
            const content = document.getElementById('perfume-details-content');
            document.getElementById('perfumeDetailsLabel').textContent = `${perfume.inspiredBy} by ${perfume.brand}`;
            const notesHTML = (notes, title) => notes && notes.length > 0 ? `<h6>${title}</h6><p class="text-muted">${notes.join(', ')}</p>` : '';
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-7">
                        <p>${perfume.description}</p><hr>
                        <h5>Scent Pyramid</h5>
                        ${notesHTML(perfume.notes.top, 'Top Notes')}
                        ${notesHTML(perfume.notes.heart, 'Heart Notes')}
                        ${notesHTML(perfume.notes.base, 'Base Notes')}
                        <button class="btn btn-info mt-3" onclick="findSimilarPerfumes('${perfume.code}')"><i class="fas fa-search"></i> Find Similar</button>
                    </div>
                    <div class="col-md-5">
                        <h5>Scent Profile</h5>
                        <canvas id="scentProfileChart"></canvas>
                    </div>
                </div>`;
            
            const ctx = document.getElementById('scentProfileChart').getContext('2d');
            const accordLabels = perfume.mainAccords || [];
            const accordData = accordLabels.map((_, i) => 10 - i * 1.5);

            if (scentProfileChart) scentProfileChart.destroy();
            scentProfileChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: accordLabels,
                    datasets: [{ label: 'Profile', data: accordData, fill: true, backgroundColor: 'rgba(var(--bs-primary-rgb), 0.2)', borderColor: 'rgb(var(--bs-primary-rgb))', pointBackgroundColor: 'rgb(var(--bs-primary-rgb))' }]
                },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { display: false } } }, plugins: { legend: { display: false } } }
            });

            perfumeDetailsModal.show();
        }

        function showBrandView(brandName) {
            state.currentView = 'brand';
            document.getElementById('main-view').classList.add('d-none');
            document.getElementById('brand-view').classList.remove('d-none');
            const brandPerfumes = allPerfumes.filter(p => p.brand === brandName);
            document.getElementById('brand-info').innerHTML = `<h2>${brandName}</h2><p>${brandPerfumes[0].brandDescription || 'No brand description available.'}</p>`;
            displayPerfumes(brandPerfumes, 'brand-perfume-list');
        }

        function findSimilarPerfumes(baseCode) {
            const basePerfume = allPerfumes.find(p => p.code === baseCode);
            const baseAccords = new Set(basePerfume.mainAccords);
            const similar = allPerfumes.filter(p => p.code !== baseCode).map(p => ({ item: p, score: (p.mainAccords || []).filter(accord => baseAccords.has(accord)).length })).sort((a, b) => b.score - a.score).slice(0, 6);
            perfumeDetailsModal.hide();
            resetAllFilters();
            const customTitle = `<h5>Showing perfumes similar to <strong>${basePerfume.inspiredBy}</strong></h5>`;
            displayPerfumes(similar, 'perfume-list', customTitle);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.handleAccordClick = (accord) => {
            if (!accord) return;
            resetAllFilters();
            const checkbox = document.querySelector(`#filter-accordion input[value="${accord}"]`);
            if (checkbox) {
                checkbox.checked = true;
                const key = checkbox.dataset.filterKey;
                if (key) {
                    state.activeFilters[key].push(accord);
                }
            }
            applyFiltersAndRender();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function handleFilterChange(e) {
            const key = e.target.dataset.filterKey;
            const value = e.target.value;
            if (e.target.checked) state.activeFilters[key].push(value);
            else state.activeFilters[key] = state.activeFilters[key].filter(v => v !== value);
            state.showingFavorites = false;
            applyFiltersAndRender();
        }

        function toggleFavorite(event) {
            const code = event.target.dataset.code;
            const index = state.favorites.indexOf(code);
            if (index > -1) state.favorites.splice(index, 1);
            else state.favorites.push(code);
            localStorage.setItem('shobi-favorites', JSON.stringify(state.favorites));
            document.getElementById('favorites-count').textContent = state.favorites.length;
            const btn = event.target;
            if (btn) btn.classList.toggle('is-favorite', index === -1);
        }
        
        function resetAllFilters() {
            document.querySelectorAll('.filter-checkbox').forEach(box => box.checked = false);
            for (const key in state.activeFilters) { state.activeFilters[key] = []; }
            state.showingFavorites = false;
            document.getElementById('favorites-btn').classList.remove('active');
            state.searchQuery = ''; 
            document.getElementById('search-input').value = '';
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', (theme === 'light' || theme === 'dark') ? theme : 'light');
            document.documentElement.setAttribute('data-theme', (theme !== 'light' && theme !== 'dark') ? theme : '');
            localStorage.setItem('shobi-theme', theme);
        }

        async function init() {
            try {
                const response = await fetch('perfumes_live.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allPerfumes = await response.json();
            } catch (error) {
                console.error("Could not load perfume data:", error);
                document.getElementById('results-count').innerHTML = `<span class="text-danger">Error: Could not load perfume data. Please check the console.</span>`;
                return;
            }

            perfumeDetailsModal = new bootstrap.Modal(document.getElementById('perfume-details-modal'));
            const savedFavorites = localStorage.getItem('shobi-favorites');
            if(savedFavorites) state.favorites = JSON.parse(savedFavorites);
            document.getElementById('favorites-count').textContent = state.favorites.length;
            createFilters();
            calculateAndShowStats();
            setTheme(localStorage.getItem('shobi-theme') || 'light');
            applyFiltersAndRender();
        }

        document.addEventListener('DOMContentLoaded', () => {
            init();

            document.getElementById('search-input').addEventListener('input', e => { 
                state.searchQuery = e.target.value; 
                state.showingFavorites = false; 
                applyFiltersAndRender(); 
            });
            document.getElementById('sort-btn-group').addEventListener('click', e => {
                if (e.target.matches('.btn')) {
                    document.querySelector('#sort-btn-group .btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    state.sortKey = e.target.id === 'sort-by-name' ? 'inspiredBy' : 'brand';
                    applyFiltersAndRender();
                }
            });
             document.getElementById('view-btn-group').addEventListener('click', e => {
                const button = e.target.closest('button');
                 if (button) {
                    document.querySelector('#view-btn-group .btn.active').classList.remove('active');
                    button.classList.add('active');
                    state.viewMode = button.id === 'view-grid' ? 'grid' : 'list';
                    applyFiltersAndRender();
                }
            });
            document.querySelectorAll('.theme-choice').forEach(item => item.addEventListener('click', e => { e.preventDefault(); setTheme(e.target.dataset.themeValue); }));
            document.getElementById('favorites-btn').addEventListener('click', () => {
                state.showingFavorites = !state.showingFavorites;
                if(state.showingFavorites) { resetAllFilters(); state.showingFavorites = true; }
                document.getElementById('favorites-btn').classList.toggle('active', state.showingFavorites);
                applyFiltersAndRender();
            });
            document.getElementById('surprise-btn').addEventListener('click', () => {
                if(allPerfumes.length > 0) {
                    const randomIndex = Math.floor(Math.random() * allPerfumes.length);
                    const randomPerfume = allPerfumes[randomIndex];
                    showPerfumeDetails(randomPerfume.code);
                }
            });
            document.getElementById('reset-filters-btn').addEventListener('click', () => { resetAllFilters(); applyFiltersAndRender(); });
            document.getElementById('back-to-all-btn').addEventListener('click', () => {
                state.currentView = 'main';
                document.getElementById('brand-view').classList.add('d-none');
                document.getElementById('main-view').classList.remove('d-none');
                applyFiltersAndRender();
            });
        });
    </script>
</body>
</html>

